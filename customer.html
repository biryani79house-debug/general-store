<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raza Wholesale and Retail - Customer Order</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: "Inter", sans-serif; }
        .gradient-bg {
            background: linear-gradient(rgba(132, 206, 248, 0.85), rgba(172, 124, 20, 0.438));
            background-size: cover;
            min-height: 100vh;
        }
        .glass-effect {
            background: rgba(236, 49, 49, 0.842);
            backdrop-filter: blur(10px);
        }
        .card-hover:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="w-full bg-green-500 shadow-sm p-1 sticky top-0 z-10">
        <div class="max-w-2xl mx-auto flex justify-center items-center">
            <div class="text-center bg-blue-500 glass-effect rounded-2xl p-3 text-white">
                <h1 class="text-xl font-bold mb-1">Raza Wholesale and Retail</h1>
                <p class="text-sm">Place your order online</p>
                <p class="text-sm"><strong>üìû +91 7075210801</strong></p>
            </div>
        </div>
    </header>

    <div class="gradient-bg">
        <main class="w-full max-w-md mx-auto p-4 space-y-4">
            <h2 class="text-2xl font-semibold text-center text-white mb-6">üçé Place Your Order</h2>

            <div class="bg-white p-3 rounded-lg shadow-sm">
                <label class="block text-sm font-medium text-gray-700 mb-1">Filter by Category</label>
                <select id="category-filter" class="w-full p-2 border border-gray-300 rounded-lg">
                    <option value="">All Categories</option>
                </select>
            </div>

            <div id="products-grid" class="grid grid-cols-2 gap-4">
                <div class="text-center py-8">
                    <p class="text-gray-500">Loading products...</p>
                </div>
            </div>

            <div id="cart-button" class="fixed bottom-4 right-4 bg-blue-500 text-white p-4 rounded-full shadow-lg hidden">
                üõí <span id="cart-count">0</span>
            </div>

            <div id="cart-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center p-4 z-20">
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">üõí Your Order</h3>
                        <button id="close-cart" class="text-2xl">&times;</button>
                    </div>
                    <div id="cart-items" class="space-y-3"></div>
                    <div class="pt-4 border-t">
                        <div class="flex justify-between font-bold text-lg mb-4">
                            <span>Total:</span>
                            <span id="cart-total">‚Çπ0.00</span>
                        </div>

                        <div class="space-y-3 mb-4">
                            <input id="customer-name" placeholder="Your Full Name" class="w-full p-2 border rounded" required>
                            <input id="customer-phone" placeholder="Phone Number" class="w-full p-2 border rounded" required>
                            <textarea id="customer-address" placeholder="Address (Optional)" class="w-full p-2 border rounded" rows="2"></textarea>
                            <textarea id="customer-notes" placeholder="Notes (Optional)" class="w-full p-2 border rounded" rows="2"></textarea>
                        </div>

                        <button id="whatsapp-order" class="w-full bg-green-500 text-white py-2 px-4 rounded shadow hover:bg-green-600">
                            üí≥ Proceed to Payment
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="notification" class="fixed top-4 right-4 bg-green-500 text-white p-3 rounded shadow-lg hidden"></div>

    <script>
        const BACKEND_URL = "https://web-production-9d240.up.railway.app";
        const SHOPKEEPER_NUMBER = "917075210801";

        let products = [];
        let cart = {};

        const productsGrid = document.getElementById('products-grid');
        const cartButton = document.getElementById('cart-button');
        const cartModal = document.getElementById('cart-modal');
        const cartItems = document.getElementById('cart-items');
        const cartTotal = document.getElementById('cart-total');
        const cartCount = document.getElementById('cart-count');
        const whatsappButton = document.getElementById('whatsapp-order');

        async function init() {
            try {
                loadCategories();
                await loadProducts();
                console.log('‚úÖ Products loaded');
            } catch (error) {
                console.error('Failed to load:', error);
                productsGrid.innerHTML = '<p class="text-red-500 text-center">Failed to load products</p>';
            }
            setupEvents();
        }

        function loadCategories() {
            fetch(`${BACKEND_URL}/categories`)
                .then(res => res.json())
                .then(categories => {
                    const select = document.getElementById('category-filter');
                    categories.forEach(cat => {
                        select.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
                    });
                    select.onchange = filterProducts;
                })
                .catch(() => console.log('Categories not available'));
        }

        async function loadProducts() {
            const response = await fetch(`${BACKEND_URL}/products`);
            if (!response.ok) throw new Error('Failed to load products');

            products = await response.json();
            displayProducts(products);
        }

        function displayProducts(productList) {
            productsGrid.innerHTML = productList.map(product => {
                const isOutOfStock = product.stock <= 0;
                const btnClass = isOutOfStock ?
                    'w-full bg-gray-400 text-white py-2 px-3 rounded cursor-not-allowed' :
                    'w-full bg-blue-500 text-white py-2 px-3 rounded hover:bg-blue-600';

                return `
                    <div class="bg-white p-4 rounded-lg shadow card-hover">
                        <h4 class="font-semibold text-center text-gray-800 mb-2">${product.name}</h4>
                        <p class="text-lg font-bold text-center mb-2">‚Çπ${product.price}</p>
                        <p class="text-xs text-center text-gray-500 mb-3">Stock: ${product.stock} ${product.unit_type}</p>
                        <button class="add-to-cart ${btnClass}" data-id="${product.id}" ${isOutOfStock ? 'disabled' : ''}>
                            ${isOutOfStock ? 'Out of Stock' : 'Add to Cart'}
                        </button>
                    </div>
                `;
            }).join('');
        }

        function filterProducts() {
            const category = this.value;
            if (!category) {
                displayProducts(products);
                return;
            }

            fetch(`${BACKEND_URL}/products?category=${category}`)
                .then(res => res.json())
                .then(filtered => displayProducts(filtered))
                .catch(() => displayProducts(products.filter(p => p.category_name === category)));
        }

        function addToCart(productId) {
            const product = products.find(p => p.id == productId);
            if (!product || product.stock <= 0) return;

            const currentQty = cart[productId] || 0;
            if (currentQty + 1 > product.stock) {
                showNotification(`Only ${product.stock} items available`);
                return;
            }

            cart[productId] = currentQty + 1;
            updateCart();
            showNotification(`Added ${product.name} to cart`);
        }

        function updateCart() {
            const items = Object.keys(cart).filter(id => cart[id] > 0);
            cartItems.innerHTML = '';
            let total = 0;
            let count = 0;

            items.forEach(productId => {
                const product = products.find(p => p.id == productId);
                const qty = cart[productId];
                const subtotal = qty * product.price;
                total += subtotal;
                count += qty;

                cartItems.innerHTML += `
                    <div class="flex justify-between items-center bg-gray-50 p-3 rounded">
                        <div class="flex-1">
                            <div class="font-medium">${product.name}</div>
                            <div class="text-sm text-gray-600">‚Çπ${product.price} each</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="decrease w-6 h-6 rounded bg-red-500 text-white text-xs" data-id="${productId}">-</button>
                            <span class="w-6 text-center">${qty}</span>
                            <button class="increase w-6 h-6 rounded bg-green-500 text-white text-xs" data-id="${productId}">+</button>
                        </div>
                        <div class="text-right ml-4">
                            <div class="font-medium">‚Çπ${subtotal.toFixed(2)}</div>
                            <button class="text-red-500 text-xs remove" data-id="${productId}">Remove</button>
                        </div>
                    </div>
                `;
            });

            cartTotal.textContent = `‚Çπ${total.toFixed(2)}`;
            cartCount.textContent = count;
            cartButton.classList.toggle('hidden', count === 0);
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.remove('hidden');
            setTimeout(() => notification.classList.add('hidden'), 3000);
        }

        function processOrder() {
            const name = document.getElementById('customer-name').value.trim();
            const phone = document.getElementById('customer-phone').value.trim();
            const address = document.getElementById('customer-address').value.trim();
            const notes = document.getElementById('customer-notes').value.trim();

            if (!name) {
                alert('Please enter your name');
                return;
            }

            if (!phone || !/^[6-9]\d{9}$/.test(phone.replace(/\s+/g, ''))) {
                alert('Please enter a valid 10-digit phone number');
                return;
            }

            const cartItems = Object.keys(cart).filter(id => cart[id] > 0);
            if (cartItems.length === 0) {
                showNotification('Cart is empty');
                return;
            }

            // Prepare order data for payment page
            const orderData = {
                customer_name: name,
                customer_phone: '+91' + phone,
                customer_address: address,
                customer_notes: notes,
                items: cartItems.map(productId => {
                    const product = products.find(p => p.id == productId);
                    return {
                        id: product.id,
                        name: product.name,
                        price: product.price,
                        quantity: cart[productId],
                        unit_type: product.unit_type
                    };
                })
            };

            // Store order data in session storage
            sessionStorage.setItem('pendingOrder', JSON.stringify(orderData));

            // Close cart modal
            cartModal.classList.add('hidden');

            // Redirect to payment page
            window.location.href = 'payment.html';
        }

        function setupEvents() {
            // Add to cart buttons
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('add-to-cart')) {
                    addToCart(e.target.getAttribute('data-id'));
                }

                if (e.target.classList.contains('decrease')) {
                    const productId = e.target.getAttribute('data-id');
                    if (cart[productId] > 1) {
                        cart[productId]--;
                        updateCart();
                    }
                }

                if (e.target.classList.contains('increase')) {
                    const productId = e.target.getAttribute('data-id');
                    const product = products.find(p => p.id == productId);
                    if (product && cart[productId] < product.stock) {
                        cart[productId]++;
                        updateCart();
                    } else {
                        showNotification('Maximum stock available');
                    }
                }

                if (e.target.classList.contains('remove')) {
                    const productId = e.target.getAttribute('data-id');
                    delete cart[productId];
                    updateCart();
                    showNotification('Item removed');
                }

                if (e.target.id === 'close-cart') {
                    cartModal.classList.add('hidden');
                }

                if (e.target.id === 'cart-button') {
                    cartModal.classList.remove('hidden');
                    cartModal.classList.add('flex');
                }

                if (e.target.id === 'whatsapp-order') {
                    processOrder();
                }
            });
        }

        // Start app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
